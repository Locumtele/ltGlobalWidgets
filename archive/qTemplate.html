<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{{FORM_TITLE}} Screening Form</title>
    <link rel="stylesheet" href="formStyle.css">  

</head> 

<body>
    <div class="form-container">
        <div class="title-box">
            <h1 id="dynamic-title">{{FORM_TITLE}} Screening</h1>
            <p class="subtitle">{{FORM_SUBTITLE}}</p>
        </div>

        <div class="form-content">
            <form id="screeningForm" data-category="{{FORM_CATEGORY}}">

                <!-- Success Message -->
                <div id="successMessage" class="success-message">
                    <h3>âœ… Form submitted successfully!</h3>
                    <p>Redirecting you to the next step...</p>
                </div>

                <!-- Patient Profile Section -->
                <div class="question-group">
                    <h2 class="question-title">Patient Profile</h2>
                    
                    <div class="question">
                        <label class="question-label" for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" class="text-input" placeholder="Enter your full name" required>
                        <div class="error-message" id="fullNameError">Full name is required</div>
                    </div>

                    <div class="question">
                        <div class="two-column-inputs">
                            <div class="input-column">
                                <label class="question-label" for="email">Email Address *</label>
                                <input type="email" id="email" name="email" class="text-input" placeholder="Enter your email address" required>
                                <div class="error-message" id="emailError">Valid email address is required</div>
                            </div>
                            <div class="input-column">
                                <label class="question-label" for="phone">Phone Number *</label>
                                <input type="tel" id="phone" name="phone" class="text-input" placeholder="Enter your phone number" maxlength="10" required>
                                <div class="error-message" id="phoneError">Phone number is required</div>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="two-column-inputs">
                            <div class="input-column">
                                <label class="question-label" for="dateOfBirth">Date of Birth *</label>
                                <input type="text" id="dateOfBirth" name="dateOfBirth" class="text-input" placeholder="MM/DD/YYYY" maxlength="10" required>
                                <div class="error-message" id="dateOfBirthError">Date of birth is required and you must be 18+ years old</div>
                            </div>
                            <div class="input-column">
                                <label class="question-label" for="weight">Weight (pounds) *</label>
                                <input type="number" id="weight" name="weight" class="text-input" min="50" max="500" placeholder="Enter your weight in pounds" required>
                                <div class="error-message" id="weightError">Please enter your weight</div>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <label class="question-label">Height (feet and inches) *</label>
                        <div class="height-inputs">
                            <div class="height-input-wrapper">
                                <input type="number" id="heightFeet" name="heightFeet" class="text-input" min="3" max="8" placeholder="Feet" required>
                                <span class="height-unit">ft</span>
                            </div>
                            <div class="height-input-wrapper">
                                <input type="number" id="heightInches" name="heightInches" class="text-input" min="0" max="11" placeholder="Inches" required>
                                <span class="height-unit">in</span>
                            </div>
                        </div>
                        <div class="error-message" id="heightError">Please enter your height</div>
                    </div>

                    <div class="question">
                        <label class="question-label">Gender *</label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="gender_male" name="gender" value="male">
                                <label for="gender_male">Male</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="gender_female" name="gender" value="female">
                                <label for="gender_female">Female</label>
                            </div>
                        </div>
                        <div class="error-message" id="genderError">Please select your gender</div>
                    </div>

                    <div class="question" id="pregnancyGroup" style="display: none;">
                        <label class="question-label">Are you currently pregnant, trying to get pregnant, or breastfeeding? *</label>
                        <div class="disqualification-message" id="pregnancyDisqualify" style="display: none;">
                            <strong>ðŸ’¡ You are not eligible for this treatment</strong><br>
                            {{PREGNANCY_DISQUALIFICATION_MESSAGE}}
                        </div>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="pregnancy_no" name="pregnancy" value="no">
                                <label for="pregnancy_no">No</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="pregnancy_yes" name="pregnancy" value="yes">
                                <label for="pregnancy_yes">Yes</label>
                            </div>
                        </div>
                        <div class="error-message" id="pregnancyError">Please answer this question</div>
                    </div>
                </div>

                <!-- Medical Assessment Section -->
                <div class="question-group">
                    <h2 class="question-title">{{ASSESSMENT_TITLE}}</h2>
                    
                    <!-- Placeholder for treatment-specific assessment questions -->
                    {{ASSESSMENT_QUESTIONS}}
                </div>

                <!-- Medical History Section -->
                <div class="question-group">
                    <h2 class="question-title">Medical History</h2>
                    
                    <div class="question">
                        <label class="question-label">Do you have a history of cancer? *</label>
                        <div class="disqualification-message" id="cancerDisqualify" style="display: none;">
                            <strong>ðŸ’¡ You are not eligible for this treatment</strong><br>
                            {{CANCER_DISQUALIFICATION_MESSAGE}}
                        </div>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="cancer_no" name="cancer" value="no">
                                <label for="cancer_no">No</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="cancer_yes" name="cancer" value="yes">
                                <label for="cancer_yes">Yes</label>
                            </div>
                        </div>
                        <div class="error-message" id="cancerError">Please answer this question</div>
                    </div>

                    <div class="question">
                        <label class="question-label">Do you have diabetes or blood sugar issues? *</label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="checkbox" id="diabetes_no" name="diabetes" value="no">
                                <label for="diabetes_no">No</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="diabetes_type1" name="diabetes" value="type1">
                                <label for="diabetes_type1">Type 1 Diabetes</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="diabetes_type2" name="diabetes" value="type2">
                                <label for="diabetes_type2">Type 2 Diabetes</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="diabetes_prediabetes" name="diabetes" value="prediabetes">
                                <label for="diabetes_prediabetes">Prediabetes</label>
                            </div>
                        </div>
                        <div class="error-message" id="diabetesError">Please answer this question</div>
                    </div>

                    <div class="question">
                        <label class="question-label" for="allergies">Do you have any allergies to medications, foods, or other substances?</label>
                        <textarea id="allergies" name="allergies" class="textarea-input" rows="3" placeholder="Please describe any allergies you have"></textarea>
                    </div>
                </div>

                <!-- Lifestyle Section -->
                <div class="question-group">
                    <h2 class="question-title">Lifestyle & Health Goals</h2>
                    
                    <div class="question">
                        <label class="question-label">What is your primary goal with {{TREATMENT_NAME}} treatment? *</label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="checkbox" id="goal_antiaging" name="treatmentGoal" value="antiaging">
                                <label for="goal_antiaging">Anti-Aging</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="goal_energy" name="treatmentGoal" value="energy">
                                <label for="goal_energy">Energy & Vitality</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="goal_sleep" name="treatmentGoal" value="sleep">
                                <label for="goal_sleep">Sleep Quality</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="goal_recovery" name="treatmentGoal" value="recovery">
                                <label for="goal_recovery">Recovery & Healing</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="goal_weight" name="treatmentGoal" value="weight">
                                <label for="goal_weight">Weight Management</label>
                            </div>
                            <div class="option-item">
                                <input type="checkbox" id="goal_muscle" name="treatmentGoal" value="muscle">
                                <label for="goal_muscle">Muscle Building</label>
                            </div>
                        </div>
                        <div class="error-message" id="treatmentGoalError">Please select your primary goal</div>
                    </div>

                    <div class="question">
                        <label class="question-label">How would you rate your current energy levels? *</label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="energy_excellent" name="energyLevel" value="excellent">
                                <label for="energy_excellent">Excellent</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="energy_good" name="energyLevel" value="good">
                                <label for="energy_good">Good</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="energy_fair" name="energyLevel" value="fair">
                                <label for="energy_fair">Fair</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="energy_poor" name="energyLevel" value="poor">
                                <label for="energy_poor">Poor</label>
                            </div>
                        </div>
                        <div class="error-message" id="energyLevelError">Please rate your energy level</div>
                    </div>

                    <div class="question">
                        <label class="question-label">How many hours of sleep do you typically get per night? *</label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="sleep_less5" name="sleepHours" value="less5">
                                <label for="sleep_less5">Less than 5 hours</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="sleep_5to6" name="sleepHours" value="5to6">
                                <label for="sleep_5to6">5-6 hours</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="sleep_6to7" name="sleepHours" value="6to7">
                                <label for="sleep_6to7">6-7 hours</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="sleep_7to8" name="sleepHours" value="7to8">
                                <label for="sleep_7to8">7-8 hours</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="sleep_more8" name="sleepHours" value="more8">
                                <label for="sleep_more8">More than 8 hours</label>
                            </div>
                        </div>
                        <div class="error-message" id="sleepHoursError">Please select your typical sleep duration</div>
                    </div>

                    <div class="question">
                        <label class="question-label">How often do you exercise per week? *</label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" id="exercise_none" name="exerciseFrequency" value="none">
                                <label for="exercise_none">No regular exercise</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="exercise_1to2" name="exerciseFrequency" value="1to2">
                                <label for="exercise_1to2">1-2 times per week</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="exercise_3to4" name="exerciseFrequency" value="3to4">
                                <label for="exercise_3to4">3-4 times per week</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" id="exercise_5plus" name="exerciseFrequency" value="5plus">
                                <label for="exercise_5plus">5+ times per week</label>
                            </div>
                        </div>
                        <div class="error-message" id="exerciseFrequencyError">Please select your exercise frequency</div>
                    </div>
                </div>

                <!-- Verification Section -->
                <div class="question-group">
                    <h2 class="question-title">Verification</h2>
                    
                    <div class="question">
                        <label class="question-label" for="driversLicense">Driver's License or Government ID *</label>
                        <div class="file-input">
                            <input type="file" id="driversLicense" name="driversLicense" accept="image/*,.pdf" required>
                            Choose File
                        </div>
                        <div class="error-message" id="driversLicenseError">Please upload your ID</div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Submitting your form...</p>
                </div>

                <!-- Submit Button Container -->
                <div class="question-group">
                    <div class="submit-container">
                        <button type="submit" class="nav-button" id="submitBtn">
                            Submit Screening Form
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Form data from JSON - Replace with actual form data
        const formData = {
            screener: "{{FORM_TITLE}}",
            category: "{{FORM_CATEGORY}}",
            type: "sync"
        };

        // DOM elements
        const form = document.getElementById('screeningForm');
        const successMessage = document.getElementById('successMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const submitBtn = document.getElementById('submitBtn');

        // ===== CORE VALIDATION FUNCTIONS =====

        // Check age (18+)
        function isOver18(dateOfBirth) {
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            const age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                return age - 1 >= 18;
            }
            return age >= 18;
        }

        // Calculate BMI
        function calculateBMI(heightFeet, heightInches, weight) {
            const totalInches = (heightFeet * 12) + heightInches;
            const heightMeters = totalInches * 0.0254;
            const weightKg = weight * 0.453592;
            return weightKg / (heightMeters * heightMeters);
        }

        // Validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Validate phone number format
        function isValidPhone(phone) {
            const phoneRegex = /^\d{10}$/;
            return phoneRegex.test(phone.replace(/\D/g, ''));
        }

        // Validate date format (MM/DD/YYYY)
        function isValidDate(dateString) {
            const dateRegex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/\d{4}$/;
            if (!dateRegex.test(dateString)) return false;
            
            const [month, day, year] = dateString.split('/').map(Number);
            const date = new Date(year, month - 1, day);
            return date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
        }

        // ===== CONDITIONAL LOGIC FUNCTIONS =====

        // Show/hide pregnancy question based on gender
        function togglePregnancyQuestion() {
            const genderFemale = document.getElementById('gender_female').checked;
            const pregnancyGroup = document.getElementById('pregnancyGroup');
            if (pregnancyGroup) {
                pregnancyGroup.style.display = genderFemale ? 'block' : 'none';
            }
        }

        // Generic function to toggle sections based on checkbox selection
        function toggleSection(checkboxId, sectionId) {
            const checkbox = document.getElementById(checkboxId);
            const section = document.getElementById(sectionId);
            if (checkbox && section) {
                section.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        // Generic function to toggle sections based on radio selection
        function toggleSectionByValue(radioName, value, sectionId) {
            const radio = document.querySelector(`input[name="${radioName}"][value="${value}"]`);
            const section = document.getElementById(sectionId);
            if (radio && section) {
                section.style.display = radio.checked ? 'block' : 'none';
            }
        }

        // ===== VALIDATION FUNCTIONS =====

        // Validate individual field
        function validateField(fieldId, validationRules = {}) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (!field) return true;

            let isValid = true;
            let errorMessage = '';

            // Required validation
            if (validationRules.required && !field.value.trim()) {
                isValid = false;
                errorMessage = validationRules.requiredMessage || `${fieldId} is required`;
            }

            // Email validation
            if (isValid && validationRules.email && field.value && !isValidEmail(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            }

            // Phone validation
            if (isValid && validationRules.phone && field.value && !isValidPhone(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid 10-digit phone number';
            }

            // Date validation
            if (isValid && validationRules.date && field.value && !isValidDate(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid date (MM/DD/YYYY)';
            }

            // Age validation
            if (isValid && validationRules.age18 && field.value && !isOver18(field.value)) {
                isValid = false;
                errorMessage = 'You must be 18 years or older';
            }

            // Min/Max validation
            if (isValid && validationRules.min && field.value && parseFloat(field.value) < validationRules.min) {
                isValid = false;
                errorMessage = `Value must be at least ${validationRules.min}`;
            }

            if (isValid && validationRules.max && field.value && parseFloat(field.value) > validationRules.max) {
                isValid = false;
                errorMessage = `Value must be no more than ${validationRules.max}`;
            }

            // Update UI
            if (isValid) {
                field.classList.remove('error');
                if (errorElement) errorElement.style.display = 'none';
            } else {
                field.classList.add('error');
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                }
            }

            return isValid;
        }

        // Validate radio button group
        function validateRadioGroup(radioName, errorId, required = true) {
            const selected = document.querySelector(`input[name="${radioName}"]:checked`);
            const errorElement = document.getElementById(errorId);
            
            if (required && !selected) {
                if (errorElement) errorElement.style.display = 'block';
                return false;
            } else {
                if (errorElement) errorElement.style.display = 'none';
                return true;
            }
        }

        // Validate checkbox group (at least one selected)
        function validateCheckboxGroup(checkboxName, errorId, required = true) {
            const selected = document.querySelectorAll(`input[name="${checkboxName}"]:checked`);
            const errorElement = document.getElementById(errorId);
            
            if (required && selected.length === 0) {
                if (errorElement) errorElement.style.display = 'block';
                return false;
            } else {
                if (errorElement) errorElement.style.display = 'none';
                return true;
            }
        }

        // Comprehensive validation function
        function validateRequiredFields() {
            let isValid = true;

            // Define validation rules for each field
            const fieldValidations = {
                'fullName': { required: true, requiredMessage: 'Full name is required' },
                'email': { required: true, email: true, requiredMessage: 'Valid email address is required' },
                'phone': { required: true, phone: true, requiredMessage: 'Phone number is required' },
                'dateOfBirth': { required: true, date: true, age18: true, requiredMessage: 'Date of birth is required and you must be 18+ years old' },
                'heightFeet': { required: true, min: 3, max: 8, requiredMessage: 'Please enter your height' },
                'heightInches': { required: true, min: 0, max: 11, requiredMessage: 'Please enter your height' },
                'weight': { required: true, min: 50, max: 500, requiredMessage: 'Please enter your weight' }
            };

            // Validate individual fields
            Object.keys(fieldValidations).forEach(fieldId => {
                if (!validateField(fieldId, fieldValidations[fieldId])) {
                    isValid = false;
                }
            });

            // Validate radio groups
            const radioGroups = [
                { name: 'gender', errorId: 'genderError' },
                { name: 'pregnancy', errorId: 'pregnancyError', conditional: () => document.getElementById('gender_female').checked },
                { name: 'cancer', errorId: 'cancerError' },
                { name: 'energyLevel', errorId: 'energyLevelError' },
                { name: 'sleepHours', errorId: 'sleepHoursError' },
                { name: 'exerciseFrequency', errorId: 'exerciseFrequencyError' }
            ];

            radioGroups.forEach(group => {
                if (!group.conditional || group.conditional()) {
                    if (!validateRadioGroup(group.name, group.errorId)) {
                        isValid = false;
                    }
                }
            });

            // Validate checkbox groups
            const checkboxGroups = [
                { name: 'treatmentGoal', errorId: 'treatmentGoalError' },
                { name: 'diabetes', errorId: 'diabetesError' }
            ];

            checkboxGroups.forEach(group => {
                if (!validateCheckboxGroup(group.name, group.errorId)) {
                    isValid = false;
                }
            });

            // Scroll to first error on mobile
            if (!isValid && isMobile()) {
                setTimeout(scrollToFirstError, 100);
            }

            return isValid;
        }

        // ===== DISQUALIFICATION FUNCTIONS =====

        // Check for disqualifying conditions
        function checkDisqualification() {
            const formData = new FormData(form);
            let hasDisqualification = false;

            // Hide all disqualification messages first
            document.querySelectorAll('.disqualification-message').forEach(msg => {
                msg.style.display = 'none';
            });

            // Check cancer
            const cancer = formData.get('cancer');
            if (cancer === 'yes') {
                const cancerDisqualify = document.getElementById('cancerDisqualify');
                if (cancerDisqualify) {
                    cancerDisqualify.style.display = 'block';
                    hasDisqualification = true;
                }
            }

            // Check pregnancy
            const pregnancy = formData.get('pregnancy');
            if (pregnancy === 'yes') {
                const pregnancyDisqualify = document.getElementById('pregnancyDisqualify');
                if (pregnancyDisqualify) {
                    pregnancyDisqualify.style.display = 'block';
                    hasDisqualification = true;
                }
            }

            // Check BMI if weight management is a goal
            const treatmentGoals = formData.getAll('treatmentGoal');
            if (treatmentGoals.includes('weight')) {
                const heightFeet = parseInt(formData.get('heightFeet'));
                const heightInches = parseInt(formData.get('heightInches'));
                const weight = parseInt(formData.get('weight'));
                
                if (heightFeet && heightInches && weight) {
                    const bmi = calculateBMI(heightFeet, heightInches, weight);
                    if (bmi < 25) {
                        const bmiDisqualify = document.getElementById('bmiDisqualify');
                        if (bmiDisqualify) {
                            bmiDisqualify.style.display = 'block';
                            hasDisqualification = true;
                        }
                    }
                }
            }

            return hasDisqualification;
        }

        // ===== FORM SUBMISSION FUNCTIONS =====

        // Show success message
        function showSuccess() {
            if (successMessage) {
                successMessage.style.display = 'block';
            }
        }

        // Handle form submission
        async function handleFormSubmission() {
            console.log('Form submitted successfully - sending to API...');
            
            try {
                // Collect form data
                const formData = new FormData(form);
                const data = {};
                
                // Convert FormData to regular object
                for (let [key, value] of formData.entries()) {
                    if (data[key]) {
                        // Handle multiple values (checkboxes)
                        if (Array.isArray(data[key])) {
                            data[key].push(value);
                        } else {
                            data[key] = [data[key], value];
                        }
                    } else {
                        data[key] = value;
                    }
                }
                
                // Add form metadata
                data.formType = '{{FORM_TITLE}}';
                data.category = '{{FORM_CATEGORY}}';
                data.timestamp = new Date().toISOString();
                data.userAgent = navigator.userAgent;
                data.url = window.location.href;
                
                // Calculate and add BMI
                const heightFeet = parseInt(data.heightFeet);
                const heightInches = parseInt(data.heightInches);
                const weight = parseInt(data.weight);
                if (heightFeet && heightInches && weight) {
                    data.bmi = calculateBMI(heightFeet, heightInches, weight).toFixed(1);
                }
                
                console.log('Submitting data to API:', data);
                
                // Submit to API
                const response = await fetch('https://locumtele.app.n8n.cloud/webhook/patient-screener', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    console.log('API submission successful');
                    showSuccess();
                    
                    // Redirect after successful API submission
                    console.log('Redirecting to next step');
                    const redirectUrl = '{{ custom_values.root_domain }}/{{REDIRECT_PATH}}';
                    
                    try {
                        window.location.href = redirectUrl;
                        console.log('Redirect command sent');
                    } catch (error) {
                        console.error('Redirect error:', error);
                        window.location.assign(redirectUrl);
                    }
                    
                    // Trigger redirect event for footer code
                    setTimeout(() => {
                        const event = new CustomEvent('ghlRedirect', {
                            detail: {
                                category: '{{FORM_CATEGORY}}',
                                consult_type: 'sync'
                            }
                        });
                        window.dispatchEvent(event);
                        console.log('Dispatched ghlRedirect event');
                    }, 2000);
                    
                } else {
                    console.error('API submission failed:', response.status, response.statusText);
                    throw new Error(`API submission failed: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Form submission error:', error);
                alert('There was an error submitting your form. Please try again.');
                throw error;
            }
        }

        // ===== MOBILE OPTIMIZATION FUNCTIONS =====

        // Check if mobile device
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Prevent zoom on input focus for iOS
        function preventZoom() {
            if (isMobile()) {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        if (this.style.fontSize !== '16px') {
                            this.style.fontSize = '16px';
                        }
                    });
                });
            }
        }

        // Smooth scroll to error messages on mobile
        function scrollToFirstError() {
            if (isMobile()) {
                const firstError = document.querySelector('.error-message[style*="block"]');
                if (firstError) {
                    firstError.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }
            }
        }

        // Improve checkbox selection on mobile
        function improveMobileCheckboxes() {
            if (isMobile()) {
                const checkboxItems = document.querySelectorAll('.option-item');
                checkboxItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (e.target !== this.querySelector('input[type="checkbox"]') && 
                            e.target !== this.querySelector('input[type="radio"]')) {
                            const checkbox = this.querySelector('input[type="checkbox"]');
                            const radio = this.querySelector('input[type="radio"]');
                            const input = checkbox || radio;
                            if (input) {
                                input.checked = !input.checked;
                                input.dispatchEvent(new Event('change'));
                            }
                        }
                    });
                });
            }
        }

        // ===== FILE UPLOAD FUNCTIONS =====

        // Setup file upload functionality
        function setupFileUploads() {
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const fileContainer = this.closest('.file-input');
                    const fileName = this.files[0] ? this.files[0].name : 'Choose File';
                    if (fileContainer) {
                        fileContainer.textContent = fileName;
                    }
                });
            });
        }

        // ===== EVENT LISTENERS =====

        // Real-time validation
        form.addEventListener('input', function(e) {
            // Validate individual field on input
            const fieldId = e.target.id;
            if (fieldId) {
                // Define validation rules for real-time validation
                const realTimeValidations = {
                    'email': { email: true },
                    'phone': { phone: true },
                    'dateOfBirth': { date: true, age18: true },
                    'heightFeet': { min: 3, max: 8 },
                    'heightInches': { min: 0, max: 11 },
                    'weight': { min: 50, max: 500 }
                };

                if (realTimeValidations[fieldId]) {
                    validateField(fieldId, realTimeValidations[fieldId]);
                }
            }

            // Check for disqualification on relevant field changes
            checkDisqualification();
        });

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submit event triggered');
            
            // Validate required fields
            console.log('Validating required fields...');
            if (!validateRequiredFields()) {
                console.log('Validation failed - required fields missing');
                return;
            }
            console.log('Required fields validation passed');

            // Check for disqualification
            console.log('Checking for disqualifications...');
            const hasDisqualification = checkDisqualification();
            if (hasDisqualification) {
                console.log('Disqualification found - form submission blocked');
                return;
            }
            console.log('No disqualifications found');

            // Show loading
            console.log('Showing loading indicator and submitting...');
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (submitBtn) submitBtn.disabled = true;

            try {
                await handleFormSubmission();
            } catch (error) {
                console.error('Form submission error:', error);
                alert('There was an error submitting your form. Please try again.');
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            }
        });

        // ===== INITIALIZATION =====

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading indicator on page load
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // Initialize conditional logic
            togglePregnancyQuestion();
            
            // Setup mobile optimizations
            preventZoom();
            improveMobileCheckboxes();
            
            // Setup file uploads
            setupFileUploads();
            
            // Add event listeners for conditional sections
            const genderFemale = document.getElementById('gender_female');
            if (genderFemale) {
                genderFemale.addEventListener('change', togglePregnancyQuestion);
            }

            // Add any custom conditional logic here
            // Example: toggleSection('checkboxId', 'sectionId');
            // Example: toggleSectionByValue('radioName', 'value', 'sectionId');
        });

        // ===== UTILITY FUNCTIONS =====

        // Format phone number as user types
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) value = value.substring(0, 10);
            input.value = value;
        }

        // Format date as user types
        function formatDate(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2);
            if (value.length >= 5) value = value.substring(0, 5) + '/' + value.substring(5, 9);
            input.value = value;
        }

        // Add phone formatting
        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                formatPhoneNumber(this);
            });
        }

        // Add date formatting
        const dateInput = document.getElementById('dateOfBirth');
        if (dateInput) {
            dateInput.addEventListener('input', function() {
                formatDate(this);
            });
        }
    </script>
</body>
</html>
