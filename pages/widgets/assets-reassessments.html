<div class="dashboard-card">
    <h2>ðŸ”„ Reassessment Forms - Embed Codes & Tracking</h2>
    <p>Copy and paste these embed codes to add reassessment forms to your website. These forms are designed for follow-up patient evaluations and treatment progress tracking.</p>
</div>

<!-- Loading State -->
<div id="forms-loading" class="dashboard-card" style="display: none;">
    <div class="dashboard-loading">
        <div class="dashboard-spinner"></div>
        <p>Loading reassessment forms...</p>
    </div>
</div>

<!-- Error State -->
<div id="forms-error" class="dashboard-card" style="display: none;">
    <div class="error">
        <h3>Error Loading Forms</h3>
        <p>There was an error loading the reassessment forms. Please try again.</p>
    </div>
</div>

<!-- Success State -->
<div id="forms-success" class="dashboard-card" style="display: none;">
    <div class="success">
        <h3>Forms Loaded Successfully</h3>
        <p>All reassessment forms have been loaded and embed codes are ready.</p>
    </div>
</div>

<!-- Forms Content -->
<div id="forms-content" class="dashboard-card">
    <h3>ðŸŽ¯ Available Reassessment Forms</h3>
    <p>Click on any form below to see its ready-to-copy embed code.</p>
    
    <div id="forms-list">
        <!-- Forms will be loaded here dynamically -->
    </div>
</div>

<div class="dashboard-card">
    <h3>ðŸ“‹ Pre-built Reassessment Examples</h3>
    <p>Ready-to-use embed codes for common reassessment scenarios.</p>
    
    <div class="form-group">
        <label class="form-label">GLP-1 Progress Reassessment:</label>
        <div class="code-block">
            <pre><code>&lt;!-- GLP-1 Progress Reassessment Form --&gt;
&lt;link rel="stylesheet" href="https://locumtele.github.io/widgets/forms/components/universalFormStyle.css"&gt;
&lt;script src="https://locumtele.github.io/widgets/forms/components/universalFormLoader.js"&gt;&lt;/script&gt;

&lt;div id="glp1-reassessment"&gt;&lt;/div&gt;

&lt;script&gt;
    const glp1ReassessmentData = {
        title: "GLP-1 Treatment Progress Reassessment",
        category: "weightloss",
        questions: [
            { text: "Full Name", type: "text", required: true },
            { text: "Email Address", type: "email", required: true },
            { text: "Phone Number", type: "phone", required: true },
            { text: "Date of Birth", type: "date", required: true },
            { text: "How long have you been on GLP-1 treatment?", type: "select", required: true, 
              options: ["Less than 1 month", "1-3 months", "3-6 months", "6-12 months", "Over 1 year"] },
            { text: "Current Weight (pounds)", type: "weight", required: true },
            { text: "Starting Weight (pounds)", type: "weight", required: true },
            { text: "How would you rate your weight loss progress?", type: "radio", required: true, 
              options: ["Excellent", "Good", "Fair", "Poor"] },
            { text: "Any gastrointestinal side effects?", type: "radio", required: true, 
              options: ["None", "Mild", "Moderate", "Severe"] },
            { text: "Appetite suppression level", type: "radio", required: true, 
              options: ["None", "Mild", "Moderate", "Strong"] },
            { text: "Would you like to continue treatment?", type: "radio", required: true, 
              options: ["Yes", "No", "Not sure"] },
            { text: "Additional comments or concerns", type: "textarea", required: false }
        ]
    };
    
    await window.generateForm(glp1ReassessmentData, 'glp1-reassessment');
&lt;/script&gt;</code></pre>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Hormone Therapy Follow-up:</label>
        <div class="code-block">
            <pre><code>&lt;!-- Hormone Therapy Follow-up Form --&gt;
&lt;link rel="stylesheet" href="https://locumtele.github.io/widgets/forms/components/universalFormStyle.css"&gt;
&lt;script src="https://locumtele.github.io/widgets/forms/components/universalFormLoader.js"&gt;&lt;/script&gt;

&lt;div id="hormone-reassessment"&gt;&lt;/div&gt;

&lt;script&gt;
    const hormoneReassessmentData = {
        title: "Hormone Therapy Follow-up Assessment",
        category: "hormone",
        questions: [
            { text: "Full Name", type: "text", required: true },
            { text: "Email Address", type: "email", required: true },
            { text: "Phone Number", type: "phone", required: true },
            { text: "Date of Birth", type: "date", required: true },
            { text: "How long have you been on hormone therapy?", type: "select", required: true, 
              options: ["Less than 1 month", "1-3 months", "3-6 months", "6-12 months", "Over 1 year"] },
            { text: "Energy level improvement", type: "radio", required: true, 
              options: ["Significant", "Moderate", "Slight", "None", "Worse"] },
            { text: "Sleep quality improvement", type: "radio", required: true, 
              options: ["Significant", "Moderate", "Slight", "None", "Worse"] },
            { text: "Mood and mental clarity", type: "radio", required: true, 
              options: ["Significant improvement", "Moderate improvement", "Slight improvement", "No change", "Worse"] },
            { text: "Any side effects experienced?", type: "textarea", required: false },
            { text: "Overall satisfaction with treatment", type: "radio", required: true, 
              options: ["Very satisfied", "Satisfied", "Neutral", "Dissatisfied", "Very dissatisfied"] }
        ]
    };
    
    await window.generateForm(hormoneReassessmentData, 'hormone-reassessment');
&lt;/script&gt;</code></pre>
        </div>
    </div>
</div>

<div class="dashboard-card">
    <h3>ðŸ”§ Footer Tracking Script</h3>
    <p>Add this script to your website's footer for proper redirect handling and form integration.</p>
    
    <div class="form-group">
        <label class="form-label">GoHighLevel Footer Code:</label>
        <div class="code-block">
            <pre><code>&lt;!-- Add this to your GHL site footer in Website Settings > Footer Code --&gt;
&lt;script src="https://locumtele.github.io/widgets/forms/components/ghl-redirect.js"&gt;&lt;/script&gt;</code></pre>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Fee Page Autofill Script:</label>
        <div class="code-block">
            <pre><code>&lt;!-- Add this to your fee pages for automatic contact info population --&gt;
&lt;script src="https://locumtele.github.io/widgets/forms/components/fee-page-autofill.js"&gt;&lt;/script&gt;</code></pre>
        </div>
    </div>
</div>

<div class="dashboard-card">
    <h3>ðŸ“Š Reassessment Form Flow</h3>
    <p>Reassessment forms follow the same flow as screening forms but are designed for follow-up evaluations:</p>
    <ol>
        <li><strong>Form Submission:</strong> Patient completes reassessment form</li>
        <li><strong>State Selection:</strong> Patient selects their state (if needed)</li>
        <li><strong>Webhook Submission:</strong> Reassessment data is sent to your webhook</li>
        <li><strong>Fee Page Redirect:</strong> Patient is redirected to appropriate fee page or consultation booking</li>
    </ol>
    
    <div class="form-group">
        <label class="form-label">Reassessment Categories:</label>
        <ul>
            <li><code>weightloss</code> â†’ Weight loss treatment follow-up</li>
            <li><code>hormone</code> â†’ Hormone therapy follow-up</li>
            <li><code>antiaging</code> â†’ Anti-aging treatment follow-up</li>
            <li><code>sexual</code> â†’ Sexual health treatment follow-up</li>
            <li><code>hairskin</code> â†’ Hair & skin treatment follow-up</li>
        </ul>
    </div>
</div>

<div class="dashboard-card">
    <h3>ðŸ’¡ Best Practices for Reassessments</h3>
    <ul>
        <li><strong>Timing:</strong> Send reassessment forms 30, 60, or 90 days after treatment starts</li>
        <li><strong>Progress Tracking:</strong> Include questions about weight, symptoms, side effects</li>
        <li><strong>Continuation:</strong> Ask about treatment satisfaction and continuation plans</li>
        <li><strong>Side Effects:</strong> Monitor for any adverse reactions or concerns</li>
        <li><strong>Follow-up:</strong> Use responses to determine if treatment adjustments are needed</li>
    </ul>
</div>

<style>
.code-block {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 1rem;
    margin: 0.5rem 0;
    overflow-x: auto;
}

.code-block pre {
    margin: 0;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.code-block code {
    background: none;
    padding: 0;
    font-family: inherit;
    font-size: inherit;
    color: #333;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

ol {
    padding-left: 1.5rem;
}

ol li {
    margin-bottom: 0.5rem;
}

ul {
    padding-left: 1.5rem;
}

ul li {
    margin-bottom: 0.25rem;
}

code {
    background: #e9ecef;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.form-item {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    margin-bottom: 1rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.form-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.form-item.active {
    border-color: #007bff;
    background: #f8f9ff;
}

.form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.form-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin: 0;
}

.form-meta {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.form-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.form-badge.category {
    background: #e3f2fd;
    color: #1976d2;
}

.form-badge.type {
    background: #e8f5e8;
    color: #2e7d32;
}

.form-badge.status {
    background: #fff3e0;
    color: #f57c00;
}

.embed-code {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
}

.embed-code.active {
    display: block;
}

.copy-button {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    transition: background 0.2s ease;
}

.copy-button:hover {
    background: #0056b3;
}

.copy-button.copied {
    background: #28a745;
}

.embed-code pre {
    margin: 0;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
    background: none;
    padding: 0;
}
</style>

<script>
// Global data storage
let formsData = [];

// Load forms data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadFormsData();
});

// Load forms data
async function loadFormsData() {
    try {
        // Show loading state
        document.getElementById('forms-loading').style.display = 'block';
        document.getElementById('forms-content').style.display = 'none';
        document.getElementById('forms-error').style.display = 'none';

        // Try to load from localStorage first
        const stored = localStorage.getItem('formsData');
        const storedTime = localStorage.getItem('lastSyncTime');
        
        if (stored && storedTime) {
            formsData = JSON.parse(stored);
            renderFormsList();
            document.getElementById('forms-loading').style.display = 'none';
            document.getElementById('forms-content').style.display = 'block';
            return;
        }

        // Load from webhook
        await refreshAllData();
    } catch (error) {
        console.error('Error loading forms data:', error);
        document.getElementById('forms-loading').style.display = 'none';
        document.getElementById('forms-error').style.display = 'block';
    }
}

// Refresh all data from webhook
async function refreshAllData() {
    try {
        const response = await fetch('https://locumtele.app.n8n.cloud/webhook/notion-forms', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Webhook response:', data);

        // Process the data
        processCombinedData(data);

        // Render forms
        renderFormsList();

        // Hide loading states and show content
        document.getElementById('forms-loading').style.display = 'none';
        document.getElementById('forms-content').style.display = 'block';

        // Show success message
        document.getElementById('forms-success').style.display = 'block';
        setTimeout(() => {
            document.getElementById('forms-success').style.display = 'none';
        }, 3000);

    } catch (error) {
        console.error('Error refreshing data:', error);
        document.getElementById('forms-loading').style.display = 'none';
        document.getElementById('forms-error').style.display = 'block';
    }
}

// Process combined data from webhook
function processCombinedData(data) {
    formsData = [];

    if (Array.isArray(data)) {
        // Separate forms and questions data
        const formItems = data.filter(item => item.id && item.name && !item.formId);
        const questionItems = data.filter(item => item.formId && item.sections);

        // Process forms
        formItems.forEach(formData => {
            formsData.push({
                id: formData.id,
                title: formData.name,
                category: formData.property_category || 'General',
                totalQuestions: formData.property_total_questions || 0,
                formType: formData.property_form_type || 'reassessment',
                status: formData.property_status || 'unknown',
                url: formData.url,
                rawData: formData
            });
        });

        // Process questions and match with forms
        questionItems.forEach(questionData => {
            const form = formsData.find(f => f.id === questionData.formId);
            if (form) {
                // Convert sections to flat questions array
                const questions = [];
                Object.keys(questionData.sections).forEach(sectionName => {
                    questionData.sections[sectionName].forEach(question => {
                        questions.push({
                            ...question,
                            section: sectionName,
                            answerOptions: question.safeAnswers || []
                        });
                    });
                });
                
                form.questions = questions;
            }
        });
    }

    // Store data
    localStorage.setItem('formsData', JSON.stringify(formsData));
    localStorage.setItem('lastSyncTime', Date.now().toString());
}

// Render forms list
function renderFormsList() {
    const container = document.getElementById('forms-list');
    if (!container) return;

    // Filter for reassessment forms only
    const reassessmentForms = formsData.filter(form => form.formType === 'reassessment');

    if (reassessmentForms.length === 0) {
        container.innerHTML = '<p>No reassessment forms available.</p>';
        return;
    }

    const formsHTML = reassessmentForms.map(form => `
        <div class="form-item" onclick="toggleFormEmbed('${form.id}')">
            <div class="form-header">
                <h4 class="form-title">${form.title}</h4>
                <div class="form-meta">
                    <span class="form-badge category">${form.category}</span>
                    <span class="form-badge type">${form.formType}</span>
                    <span class="form-badge status">${form.status}</span>
                    <span class="form-badge">${form.totalQuestions} questions</span>
                </div>
            </div>
            
            <div class="embed-code" id="embed-${form.id}">
                <button class="copy-button" onclick="copyEmbedCode('${form.id}')">Copy Embed Code</button>
                <pre><code>${generateEmbedCode(form)}</code></pre>
            </div>
        </div>
    `).join('');

    container.innerHTML = formsHTML;
}

// Toggle form embed code
function toggleFormEmbed(formId) {
    const formItem = document.querySelector(`[onclick="toggleFormEmbed('${formId}')"]`);
    const embedCode = document.getElementById(`embed-${formId}`);
    
    // Close all other embed codes
    document.querySelectorAll('.embed-code').forEach(code => {
        if (code.id !== `embed-${formId}`) {
            code.classList.remove('active');
        }
    });
    
    document.querySelectorAll('.form-item').forEach(item => {
        if (item !== formItem) {
            item.classList.remove('active');
        }
    });
    
    // Toggle current embed code
    embedCode.classList.toggle('active');
    formItem.classList.toggle('active');
}

// Generate embed code for a form
function generateEmbedCode(form) {
    const formData = {
        title: form.title,
        category: form.category,
        questions: form.questions || []
    };
    
    return `<!-- ${form.title} - Universal Form System -->
<link rel="stylesheet" href="https://locumtele.github.io/widgets/forms/components/universalFormStyle.css">
<script src="https://locumtele.github.io/widgets/forms/components/universalFormLoader.js"></script>

<div id="form-container-${form.id}"></div>

<script>
    const formData = ${JSON.stringify(formData, null, 4)};
    
    // Generate form
    window.generateForm(formData, 'form-container-${form.id}');
</script>

<!-- Add this to your site footer for proper redirect handling -->
<script src="https://locumtele.github.io/widgets/forms/components/ghl-redirect.js"></script>`;
}

// Copy embed code to clipboard
async function copyEmbedCode(formId) {
    const embedCode = document.querySelector(`#embed-${formId} pre code`).textContent;
    const button = document.querySelector(`[onclick="copyEmbedCode('${formId}')"]`);
    
    try {
        await navigator.clipboard.writeText(embedCode);
        button.textContent = 'Copied!';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.textContent = 'Copy Embed Code';
            button.classList.remove('copied');
        }, 2000);
    } catch (err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = embedCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        button.textContent = 'Copied!';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.textContent = 'Copy Embed Code';
            button.classList.remove('copied');
        }, 2000);
    }
}
</script>
